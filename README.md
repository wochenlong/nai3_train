
#  nai3_train
è‹±æ–‡ç‰ˆè¯´æ˜ï¼š[English Documentation](./README_EN.md)

å¦‚æœä½ éœ€è¦ä½¿ç”¨nai3ç”Ÿæˆçš„å›¾ç‰‡æ¥æ‰¹é‡è®­ç»ƒä½ çš„SDæ¨¡å‹ï¼Œé‚£æˆ‘æƒ³ä½ éœ€è¦è¿™ä¸ªé¡¹ç›®ã€‚

nai3ç”Ÿæˆçš„å›¾ç‰‡ï¼Œä¸€é”®ç”Ÿæˆã€æ‰“æ ‡å’Œå¤„ç†è„šæœ¬

åŸç†1ï¼šä»prompt_folderéšæœºæŠ½å–txtä½œä¸ºpromptæ‰¹é‡ç”Ÿæˆéšæœºç´ æ

   æŠŠä½ çš„æ‰“æ ‡txtå˜æˆä½ çš„éšæœºæç¤ºè¯åº“ï¼

åŸç†2ï¼šä»jsonä¸­éšæœºæŠ½å–è§’è‰²ç”Ÿæˆéšæœºè§’è‰²ï¼Œæˆ–è€…æŒ‰é¡ºåºç”Ÿæˆæ‰€æœ‰è§’è‰²

å¤‡æ³¨ï¼šä¸å‚¬æ›´å°±ä¸æ›´æ–°ï¼Œæ›´å¤šæ–°åŠŸèƒ½å¼€å‘ä¸­
# ç”Ÿæˆçš„éšæœºè§’è‰²æ•ˆæœï¼š
å›¾ä¸€

![VA}S0W4AL6_ZIV~2 (BDX5](https://github.com/wochenlong/nai3_train/assets/117965575/6bfecd63-fa7f-4b36-bef9-1e8df2eef21f)

å›¾äºŒ

![0~O)3% YX{SRSL$2VY)PTJ](https://github.com/wochenlong/nai3_train/assets/117965575/093c08fc-bf83-4d38-a282-7470bf48e316)




å›¾ä¸‰ï¼š

![L_ZUGFLNWQXDY~4(A4~5XK2](https://github.com/wochenlong/nai3_train/assets/117965575/711aff18-3ef7-4390-889e-c0ffc846418e)

å›¾å››ï¼š
![V2L6B62X60RU7((XCBMAN 9](https://github.com/wochenlong/nai3_train/assets/117965575/7b290ae4-5d77-4210-9276-519bd8afe6d6)



# ç”Ÿæˆçš„éšæœºç´ ææ•ˆæœï¼š

å›¾å››ï¼š
![8R@KZV(13`(0U~25~KKQTR7](https://github.com/wochenlong/nai3_train/assets/117965575/1c5a42bf-b44e-48a6-aaab-aa5487554a42)


å›¾äº”ï¼š
![N9 KXF41KXXB2T~CKZ2VS`M](https://github.com/wochenlong/nai3_train/assets/117965575/37e1801f-bfea-4f7c-8701-ed4047c29a28)


## å¼€æºéšæœºæç¤ºè¯åº“
æµ·é‡txtéšæœºæç¤ºè¯ï¼Œè§£å‹åæ”¾è¿›`prompt_folder`å³å¯ã€‚

ä¸€ã€ 4Ké«˜è´¨é‡æç¤ºè¯åº“ ï¼šhttps://huggingface.co/datasets/windsingai/random_prompt/resolve/main/prompt_4k.zip

 ç‰¹ç‚¹ï¼šäººå·¥æ•´ç†ï¼Œè‰¯å“ç‡é«˜ï¼Œå®‰å…¨æ€§é«˜ï¼Œåªæœ‰2%çš„nsfw

 å†…å®¹ï¼šä»¥äººç‰©å’Œæ„å›¾ä¸ºä¸»

 æ¥æºï¼šä¿®æ”¹è‡ªå°¤å‰çš„AIDè®­ç»ƒé›†çš„æ‰“æ ‡æ–‡ä»¶

äºŒã€ 20wé«˜è´¨é‡æç¤ºè¯åº“ ï¼šhttps://huggingface.co/datasets/windsingai/random_prompt/resolve/main/prompt_20W.zip

  ç‰¹ç‚¹ï¼šçœŸå®å›¾ç‰‡åæ¨ï¼Œæ•°é‡å¤šï¼ŒäºŒæ¬¡å…ƒæµ“åº¦é«˜ï¼Œè¶³å¤Ÿæ³›åŒ–ï¼Œçº¦æœ‰20%çš„nsfw

  å†…å®¹ï¼šé¢˜æå¾ˆå¤šï¼Œè€ƒè™‘åˆ°danbooruçš„æ„æˆï¼Œä¸»è¦è¿˜æ˜¯ä»¥å¥³æ€§ä¸ºä¸»
  
  æ¥æºï¼šä» https://danbooru.donmai.us/ æ‰¹é‡çˆ¬å–ï¼Œä¿®æ”¹è‡ªæ æ å“¥çš„20Wè®­ç»ƒé›†
 
 
## æ–°åŠŸèƒ½ï¼š éšæœº/æŒ‰é¡ºåºç”ŸæˆæŒ‡å®šè§’è‰²çš„å›¾ç‰‡

åŸç†ï¼Œä»jsonè¯»å–è§’è‰²åï¼Œç”Ÿæˆå›¾ç‰‡

æœ¬ä»“åº“å†…ç½®åŒ…æ‹¬åŸç¥ã€æ˜æ—¥æ–¹èˆŸã€fgoç­‰å¤šä¸ªä¸»æµæ¸¸æˆçš„éšæœºè§’è‰²åº“ã€‚

ä¾‹ï¼š
ä½¿ç”¨é€šè¿‡è¯»å–.\json\genshin.json æ–‡ä»¶ï¼Œå®ç°éšæœºåŸç¥è§’è‰²ç”Ÿæˆã€‚




jsonæ–‡ä»¶çš„ç»“æ„ï¼Œä»¥genshin.jsonä¸ºä¾‹ï¼š

```
{
  "role": [
    "noelle_(genshin_impact)",
    "faruzan_(genshin_impact)",
    "è§’è‰²1",
    "è§’è‰²2",
    "è§’è‰²3",
    .....
  ]
```

ä¸‹é¢ä¸ºrandom_characetrs.pyè„šæœ¬çš„éƒ¨åˆ†ä»£ç ï¼š
```

# ç”¨æˆ·è‡ªå®šä¹‰ è§’è‰² JSON æ–‡ä»¶çš„è·¯å¾„
characters_path = "./json/arknights_ge_50.json"
# ç”Ÿæˆå›¾åƒæ–‡ä»¶çš„ä¿å­˜è·¯å¾„
folder_path = ".\output"
# é€‰æ‹©è¯»å–æ–¹å¼
read_mode = 1  # -1ä¸ºéšæœºè¯»å–ï¼Œ1ä¸ºæŒ‰é¡ºåºè¯»å–
# è®¾ç½®è§’è‰²ä¼˜å…ˆçº§
role_priority = 1  # é»˜è®¤ä¸ºä¸ç”Ÿæ•ˆ,é€‰æ‹©1æ—¶ï¼ŒæŠŠè§’è‰²è¯ä¼˜å…ˆæ”¾prefix å‰é¢
# é€‰æ‹© seed
seed = 6666  # é»˜è®¤éšæœº seedï¼Œä¸å¡«æˆ–è€…è®¾ç½®ä¸º-1æ—¶ä¸ºéšæœºseed

# ç”Ÿæˆå¤šå¼ å›¾åƒå¹¶ä¿å­˜
num_images = 200  # è¦ç”Ÿæˆçš„å›¾åƒæ•°é‡
batch_size = 10  # æ¯æ‰¹æ¬¡ç”Ÿæˆçš„å›¾åƒæ•°é‡
retry_delay = 20  # æ¯æ‰¹æ¬¡ç”Ÿæˆåçš„ä¼‘çœ æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰

sleep_time = 10  # æ¯æ‰¹æ¬¡ç”Ÿæˆåçš„ä¼‘çœ æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰

retry_delay = 60  # å› ä¸ºæŠ¥é”™ä¸­æ–­ï¼Œè„šæœ¬çš„é‡æ–°å¯åŠ¨æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
prefix = "official art,cowboy shot,standing,white background, "  # åŠ åœ¨æç¤ºè¯å‰é¢çš„å›ºå®šç”»é£è¯æˆ–è´¨é‡è¯

class NovelaiImageGenerator:
    def __init__(self, characters_path, negative_prompt):
        self.token = "xxx" # è¯·è‡ªè¡Œè·å–
....

```
å‚æ•°è¯´æ˜ï¼š
- `self.token`ï¼šç”Ÿå›¾å¿…éœ€çš„tokenï¼Œæˆæƒä»¤ç‰Œã€‚è·å–æ–¹å¼å¦‚ä¸‹ï¼š
  - åœ¨ç½‘é¡µï¼ˆhttps://novelai.netï¼‰ ä¸­ç™»å½•ä½ çš„ NovelAI è´¦å·
  - æ‰“å¼€æ§åˆ¶å° (F12)ï¼Œå¹¶åˆ‡æ¢åˆ°æ§åˆ¶å° (Console) æ ‡ç­¾é¡µ
  - è¾“å…¥ä¸‹é¢çš„ä»£ç å¹¶æŒ‰ä¸‹å›è½¦è¿è¡Œï¼š
    ```javascript
    console.log(JSON.parse(localStorage.session).auth_token)
    ```
  - è¾“å‡ºçš„å­—ç¬¦ä¸²å°±æ˜¯ä½ çš„æˆæƒä»¤ç‰Œ
- `characters_path`ï¼š è§’è‰² JSON æ–‡ä»¶çš„è·¯å¾„ï¼Œä»è¿™ä¸ª JSONéšæœºæŠ½å–è§’è‰²ç”Ÿæˆ
- `read_mode `ï¼šé€‰æ‹©è¯»å–jsoné‡Œé¢çš„è§’è‰²çš„æ–¹å¼ï¼Œ-1ä¸ºéšæœºè¯»å–ï¼Œ1ä¸ºæŒ‰é¡ºåºè¯»å–
- `prefix`ï¼šé»˜è®¤å‰ç¼€ï¼Œè‡ªå®šä¹‰çš„è´¨é‡è¯æˆ–è€…å›ºå®šçš„ç”»å®¶é£æ ¼
- `role_priority`ï¼šè®¾ç½®è§’è‰²ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¸ç”Ÿæ•ˆï¼Œå½“é€‰æ‹©1æ—¶ï¼ŒæŠŠè§’è‰²è¯ä¼˜å…ˆæ”¾prefixå‰é¢
- `seed`ï¼šç§å­ï¼Œé»˜è®¤éšæœº seedï¼Œä¸å¡«æˆ–è€…è®¾ç½®ä¸º-1æ—¶ä¸ºéšæœºseed
- `negative_prompt`ï¼šè´Ÿé¢æç¤ºè¯
- `num_images`ï¼šç”Ÿæˆå›¾ç‰‡çš„æ€»æ•°é‡
- `batch_size`ï¼šæ¯æ‰¹æ¬¡ç”Ÿæˆçš„å›¾åƒæ•°é‡
- `sleep_time`ï¼š æ¯æ‰¹æ¬¡ç”Ÿæˆåçš„ä¼‘çœ æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
- `retry_delay`ï¼š è„šæœ¬é‡åˆ°å¼‚å¸¸ä¸­æ–­åï¼Œé‡æ–°è‡ªåŠ¨å¯åŠ¨çš„æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰

è¿è¡Œå‘½ä»¤ï¼š`Python random_characetrs.py`




## 1. è¯»å–éšæœºæç¤ºè¯åº“ï¼Œæ‰¹é‡ç”Ÿæˆéšæœºnai3å›¾ç‰‡

ä»¥ä¸‹ä¸º random_prompt.pyè„šæœ¬çš„éƒ¨åˆ†ä»£ç 

```
...
class NovelaiImageGenerator:
    def __init__(self, prompt_folder, negative_prompt):
        # åˆå§‹åŒ–å‡½æ•°ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šprompt_folder å’Œ negative_prompt
   self.token = "xxx"  # è®¾ç½® API çš„è®¿é—®ä»¤ç‰Œ
...

# åˆ›å»º NovelaiImageGenerator å®ä¾‹
generator = NovelaiImageGenerator(
    prompt_folder=".\prompt",
    negative_prompt=" nsfw, lowres, ",
)

# ç”Ÿæˆå›¾åƒæ–‡ä»¶çš„ä¿å­˜è·¯å¾„
folder_path = ".\output"

# ç”Ÿæˆå¤šå¼ å›¾åƒå¹¶ä¿å­˜
num_images = 1000  # è¦ç”Ÿæˆçš„å›¾åƒæ•°é‡
batch_size = 10  # æ¯æ‰¹æ¬¡ç”Ÿæˆçš„å›¾åƒæ•°é‡
retry_delay = 20  # æ¯æ‰¹æ¬¡ç”Ÿæˆåçš„ä¼‘çœ æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰

sleep_time = 10  # æ¯æ‰¹æ¬¡ç”Ÿæˆåçš„ä¼‘çœ æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰

retry_delay = 60  # å› ä¸ºæŠ¥é”™ä¸­æ–­ï¼Œè„šæœ¬çš„é‡æ–°å¯åŠ¨æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
prefix = "amazing quality, absurdres, year 2023, " é»˜è®¤å‰ç¼€ 



```

å¿…å¡«å‚æ•°ï¼š
- `self.token`ï¼šç”Ÿå›¾å¿…éœ€çš„tokenï¼Œæˆæƒä»¤ç‰Œã€‚è·å–æ–¹å¼å¦‚ä¸‹ï¼š
  - åœ¨ç½‘é¡µï¼ˆhttps://novelai.netï¼‰ ä¸­ç™»å½•ä½ çš„ NovelAI è´¦å·
  - æ‰“å¼€æ§åˆ¶å° (F12)ï¼Œå¹¶åˆ‡æ¢åˆ°æ§åˆ¶å° (Console) æ ‡ç­¾é¡µ
  - è¾“å…¥ä¸‹é¢çš„ä»£ç å¹¶æŒ‰ä¸‹å›è½¦è¿è¡Œï¼š
    ```javascript
    console.log(JSON.parse(localStorage.session).auth_token)
    ```
  - è¾“å‡ºçš„å­—ç¬¦ä¸²å°±æ˜¯ä½ çš„æˆæƒä»¤ç‰Œ

- `prompt_folder`ï¼šä»è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢éšæœºæŠ½å–TXTï¼Œä½œä¸ºæç¤ºè¯
- `prefix`ï¼šé»˜è®¤å‰ç¼€ï¼Œè‡ªå®šä¹‰çš„è´¨é‡è¯æˆ–è€…å›ºå®šçš„ç”»å®¶é£æ ¼
- `negative_prompt`ï¼šè´Ÿé¢æç¤ºè¯
- `num_images`ï¼šç”Ÿæˆå›¾ç‰‡çš„æ€»æ•°é‡
- `batch_size`ï¼šæ¯æ‰¹æ¬¡ç”Ÿæˆçš„å›¾åƒæ•°é‡
- `sleep_time`ï¼š æ¯æ‰¹æ¬¡ç”Ÿæˆåçš„ä¼‘çœ æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
- `retry_delay`ï¼š è„šæœ¬é‡åˆ°å¼‚å¸¸ä¸­æ–­åï¼Œé‡æ–°è‡ªåŠ¨å¯åŠ¨çš„æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰

è¿è¡Œå‘½ä»¤ï¼š`Python random_prompt`

## 2. è¯»å–å›¾ç‰‡ä¿¡æ¯ï¼Œå¹¶ç”ŸæˆtxtåŒåæ–‡ä»¶

è¿è¡Œå‘½ä»¤ï¼š`Python nai3tagger.py`

ç„¶åæŒ‰æç¤ºè¾“å…¥è¦å¤„ç†çš„æ–‡ä»¶å¤¹è·¯å¾„å³å¯

## 3. å»æ‰txtæ–‡ä»¶ä¸­çš„å‰ç¼€`prefix` ï¼Œç»‘å®šç”»é£
ä»¥ä¸‹æ˜¯è„šæœ¬çš„éƒ¨åˆ†ä»£ç ï¼š

```
import os

prefix = "amazing quality,  artist:xxx, year 2023, "

dirpath = r".\output_nsfw
```
- `prefix`ï¼šé»˜è®¤å‰ç¼€ï¼Œè¦å»æ‰çš„è´¨é‡è¯æˆ–è€…å›ºå®šçš„ç”»å®¶é£æ ¼
- `dirpath`ï¼šè¦å¤„ç†çš„æ–‡ä»¶å¤¹è·¯å¾„

è¿è¡Œå‘½ä»¤ï¼š`Python clear.py`

## 4. å»æ‰txtæ–‡ä»¶ä¸­çš„éæ³•å­—ç¬¦ï¼Œæ¯”å¦‚ğŸ˜„ğŸ™ƒ

txtæ–‡ä»¶ä¸­çš„éƒ¨åˆ†éæ³•å­—ç¬¦ï¼Œå¯èƒ½ä¼šä»¤è®­ç»ƒå‘ç”ŸæŠ¥é”™ï¼Œè®­ç»ƒè„šæœ¬æ— æ³•è¯»å–txtï¼Œå› æ­¤ï¼Œå»æ‰éæ³•å­—ç¬¦æ˜¯å¿…éœ€çš„

ä»¥ä¸‹æ˜¯è„šæœ¬çš„éƒ¨åˆ†ä»£ç 

```
# æŒ‡å®šå«æœ‰é UTF-8 ç¼–ç å­—ç¬¦çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•
directory_path = r".\data"

# æŒ‡å®šç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼Œç”¨äºå­˜æ”¾ç§»åŠ¨åçš„æ–‡ä»¶
destination_path = r".\data"
```

- `directory_path`ï¼šæŒ‡å®šå«æœ‰é UTF-8 ç¼–ç å­—ç¬¦çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•
- `destination_path`ï¼šæŒ‡å®šç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼Œç”¨äºå­˜æ”¾ç§»åŠ¨åçš„æ–‡ä»¶


è¿è¡Œå‘½ä»¤ï¼š`Python UTF-8.py`

## 5. å»æ‰å›¾ç‰‡ä¸­çš„æ°´å° ï¼ˆæµ‹è¯•åŠŸèƒ½ï¼‰
#### 5.1 å»æ‰åœ¨å›¾ç‰‡åº•éƒ¨çš„æ°´å°
è¿™æ˜¯cut.pyè„šæœ¬çš„éƒ¨åˆ†ä»£ç 


```
...
# æºå›¾ç‰‡è·¯å¾„
source_path = r".\output\sfw_6000"

# æ–°æ–‡ä»¶å¤¹è·¯å¾„
output_path = r".\output\sfw_6000_cropped"

# åˆ›å»ºæ–°æ–‡ä»¶å¤¹
os.makedirs(output_path, exist_ok=True)

# è·å–æºå›¾ç‰‡è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
files = [f for f in os.listdir(source_path) if f.endswith(".png")]

# è¿›åº¦æ¡
progress_bar = tqdm(total=len(files), desc="Processing images")

# éå†æºå›¾ç‰‡è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
for filename in files:
    # åŠ è½½å›¾ç‰‡
    image_path = os.path.join(source_path, filename)
    image = Image.open(image_path)

    # è£å‰ªåº•éƒ¨100åƒç´ 
    cropped_image = image.crop((0, 0, 832, 1116))

    # ç”Ÿæˆæ–°æ–‡ä»¶è·¯å¾„
    output_file = os.path.join(output_path, filename)

    # ä¿å­˜è£å‰ªåçš„å›¾ç‰‡åˆ°æ–°æ–‡ä»¶å¤¹
    cropped_image.save(output_file)

  ...
```

å‚æ•°è¯´æ˜ï¼š

- `source_path`ï¼šæºå›¾ç‰‡è·¯å¾„
- `output_path`ï¼šæ–°æ–‡ä»¶å¤¹è·¯å¾„

è¿è¡Œå‘½ä»¤ï¼š`Python cut.py`
